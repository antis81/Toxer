#!/bin/sh -e

SCRIPT_DIR=$(dirname `readlink -f -- $0`)

PROJECT_DIR=$SCRIPT_DIR
GIT_REMOTE=${GIT_REMOTE:-'https://gitlab.com/antis81/toxer-core.git'}
GIT_BRANCH=${GIT_BRANCH:-'master'}
GIT_DEST_DIR="$PROJECT_DIR/src"

QT_BASE_DIR=${QT_BASE_DIR:-"$HOME/Qt"}
QT_TOOLCHAIN=${QT_TOOLCHAIN:-'gcc_64'}
QT_VERSION=${QT_VERSION:-'5.6'}
QT_DIR="$QT_BASE_DIR/$QT_VERSION/$QT_TOOLCHAIN"

PATH="$QT_DIR/bin:$PATH"

echo 'Configuring Toxer for buildâ€¦
[Step #1 - Fetch Toxer core components]
'

if [ -d "$GIT_DEST_DIR" ] ; then
  echo "Toxer core components directory exists. Fetching branch \"$GIT_BRANCH\""
  git -C "$GIT_DEST_DIR" fetch $GIT_REMOTE $GIT_BRANCH
  echo "Updated Toxer core components in $GIT_DEST_DIR"
else
  git clone -q --progress --no-checkout --branch="$GIT_BRANCH" \
    $GIT_REMOTE $GIT_DEST_DIR
  git -C "$GIT_DEST_DIR" checkout
  git -C "$GIT_DEST_DIR" config commit.gpgsign 'true'
  echo "Cloned Toxer sources to $GIT_DEST_DIR."
fi

echo '[Step #2 - Fetch toxcore sources]'
"$SCRIPT_DIR/scripts/getToxCore.sh"

echo '[Step #3 - Setup CMake build environment]'

PREV_DIR=$PWD
mkdir -p "$PROJECT_DIR/build"
cd "$PROJECT_DIR/build"
cmake ..
cd "$PREV_DIR"

echo 'Toxer configuration finished! To build Toxer run
  make -j$(nproc) -C build
'

